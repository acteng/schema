---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE
)
library(tidyverse)
library(tmap)
```

# CID data types

Converted into a dataset in the Arrow format, the column names and associated data types, example values, asset types and labels are as follows, for the Cycle lane/track table, for example:

```{r get_cid_once, eval=FALSE}
# Get schema
u = "https://cycling.data.tfl.gov.uk/CyclingInfrastructure/documentation/cid_database_schema.xlsx"
f = basename(u)
if (!file.exists(f)) {
  download.file(u, f)
}
readxl::excel_sheets(f)
tfl_schema = readxl::read_excel(f, sheet = 3)
write_csv(tfl_schema, "example_data/tfl_field_names.csv")
library(osmdata)
remotes::install_github("PublicHealthDataGeek/CycleInfraLnd")
?CycleInfraLnd::get_cid_lines
blackfriars_bridge_road = opq(bbox = "London") |> 
  add_osm_feature(key = "name", value = "Blackfriars Bridge") |> 
  osmdata_sf() |> 
  pluck("osm_multilines")
blackfriars_buffer = sf::st_buffer(blackfriars_bridge_road, 500)
mapview::mapview(blackfriars_bridge_road)
cid_cycle_lane_track = CycleInfraLnd::get_cid_lines(type = "cycle_lane_track")
is_true_false = function(x) {
  all(x %in% c("TRUE", "FALSE"))
}
is_true_false(cid_cycle_lane_track$CLT_CARR)
is_true_false(cid_cycle_lane_track$FEATURE_ID)
cid_cycle = cid_cycle_lane_track |> 
  mutate_if(.predicate = is_true_false, .funs = as.logical) 
cid_cycle_lane_track_blackfriars = cid_cycle_lane_track[blackfriars_buffer, , op = sf::st_within] |> 
  mutate_if(.predicate = is_true_false, .funs = as.logical) 
dir.create("example_data")
sf::write_sf(cid_cycle_lane_track_blackfriars, "example_data/cid_cycle_lane_track_blackfriars.geojson", delete_dsn = TRUE)
tm_shape(cid_cycle_lane_track_blackfriars) +
  tm_lines()

# ASL data
cid_asl = CycleInfraLnd::get_cid_lines(type = "advanced_stop_line")
cid_cycle = cid_asl |> 
  mutate_if(.predicate = is_true_false, .funs = as.logical) 
cid_asl_blackfriars = cid_asl[blackfriars_buffer, , op = sf::st_within] |> 
  mutate_if(.predicate = is_true_false, .funs = as.logical) 
sf::write_sf(cid_asl_blackfriars, "example_data/cid_asl_blackfriars.geojson", delete_dsn = TRUE)
tm_shape(cid_asl_blackfriars) +
  tm_lines()
```

```{r, message=FALSE}
tfl_schema = read_csv("example_data/tfl_field_names.csv")
tfl_schema = tfl_schema |> 
  rename(Name = fieldname)
cid_cycle_lane = sf::read_sf("example_data/cid_cycle_lane_track_blackfriars.geojson")
# table(cid_cycle_lane$CLT_CARR)
# cid_cycle_lane_track_blackfriars |> as_tibble() |> slice(1:3)
cid_cycle_lane_df = cid_cycle_lane |> 
  sf::st_drop_geometry()
cid_cycle_lane_arrow = cid_cycle_lane_df |> 
  arrow::as_arrow_table()
arrow::write_parquet(cid_cycle_lane_arrow, "example_data/cid_cycle_lane_track_blackfriars.parquet")
# cid_cycle_lane_schema = cid_cycle_lane_arrow$schema
# cid_cycle_lane_schema[2]
# cid_cycle_types = NULL
# i = 1
# for(i in seq(ncol(cid_cycle_lane_df))) {
#   cid_cycle_types = c(cid_cycle_types, class(arrow::infer_type(cid_cycle_lane_schema[]))[1])
# }
cid_cycle_types = map_chr(cid_cycle_lane_df, function(x) class(arrow::infer_type(x))[1])
cid_cycle_example_value = as.character(cid_cycle_lane_df[1, ])
cid_cycle_schema = tibble(
  Name = names(cid_cycle_types),
  Type = cid_cycle_types,
  Example = cid_cycle_example_value
)
cid_cycle_schema = inner_join(cid_cycle_schema, tfl_schema)
cid_cycle_schema = cid_cycle_schema |> 
  mutate(description = gsub(pattern = "\\n", replacement = " ", x = description))
# arrow::type(cid_cycle_lane_arrow$columns)
# map(cid_cycle_lane_track, arrow::infer_type)
# cid_cycle_lane_schema$names
# cid_cycle_lane_schema$num_fields
# as.ch(cid_cycle_lane_schema$fields)
knitr::kable(cid_cycle_schema)
```

```{r, message=FALSE}
cid_cycle_lane_df = cid_cycle_lane |> 
  sf::st_drop_geometry()
cid_cycle_lane_arrow = cid_cycle_lane_df |> 
  arrow::as_arrow_table()
cid_cycle_out = utils::capture.output(cid_cycle_lane_arrow)
```

In a future schema, many of the variables in the schema above could be replaced by a well-defined 'type' column that accepts values including On Road Advisory Cycle Lane, Dedicated Cycle Track and Stepped Cycle Track (covering columns 3 to 5 in the above table).
See the repo <https://github.com/PublicHealthDataGeek/CycleInfraLnd/> and associated paper (Tait et al., [2022](https://www.sciencedirect.com/science/article/pii/S221414052200041X)) for further details on the CID.
